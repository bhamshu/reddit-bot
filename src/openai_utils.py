import os
from openai import OpenAI
from dotenv import load_dotenv
from gspread_utils import gsheet, init_reviews_worksheet, append_to_sheet, init_keywords_worksheet, fetch_column_from_sheet

# Load environment variables
load_dotenv()

# Create an OpenAI client with your API key
client = OpenAI(api_key=os.getenv('OPENAI_API_KEY'))
def generate_reply(prompt_dict):
    blacklist_worksheet = init_keywords_worksheet(gsheet, 2)
    blacklist_arr = fetch_column_from_sheet(blacklist_worksheet, "blacklist")
    blacklist_string = ', '.join(blacklist_arr)

    prompt = create_prompt_to_generate_reply(prompt_dict["title"], prompt_dict["content"], prompt_dict["username"], prompt_dict["user_summary"])

    response = client.chat.completions.create(
        model="gpt-3.5-turbo",
         messages=[
            {"role": "system", "content": f"You're crafting a supportive response as a friend to a Reddit post by \"[username]\". The post, titled \"[title]\", delves into \"[content]\", reflecting concerns and feelings unique to the user, with a background summarized as \"[user_summary]\". In your reply, directly address these points with empathy and understanding, drawing from the user's shared experiences. Offer support.Focus solely on offering personal support, inviting the user to reach out to you for a one-on-one discussion. Keep the tone casual, friendly, and precisely attuned to the user's needs, ensuring your reply feels like a natural extension of a Reddit conversation. Only suggest reaching out to you directly for further assistance or a thoughtful conversation that could help them navigate their situation. And don't give any other suggestion/advice to the user except for therapy sessions (that too only if needed). Keep the reply precise, convincing and friendly, upto 3-4 sentences. Dont use any words from '{blacklist_string}', or any words similar to these. If you want to say 'mental health', say 'mental wellness', and similar with other words. Don't use the word 'health' explicitily. And use only common words. \n Data is provided in the format: 'Title: \"[title]\", Content: \"[content]\", Username: \"[username]\", User Summary: \"[user_summary]\"'"},
            {"role": "user", "content": training_prompts[0]["prompt"]},
            {"role": "assistant", "content": training_prompts[0]["response"]},
            {"role": "user", "content": training_prompts[1]["prompt"]},
            {"role": "assistant", "content": training_prompts[1]["response"]},
            {"role": "user", "content": training_prompts[2]["prompt"]},
            {"role": "assistant", "content": training_prompts[2]["response"]},
            {"role": "user", "content": training_prompts[3]["prompt"]},
            {"role": "assistant", "content": training_prompts[3]["response"]},
            {"role": "user", "content": prompt}
        ]
    )

    reply = response.choices[0].message.content
    return reply.strip()

def generate_user_summary(user_posts):
    user_details = ""
    for post in user_posts:
        user_details += f"Title: {post['title']}, Content: {post['content']}, Username: {post['username']}, Date of Post: {post['date_of_post']}, URL of Post: {post['url']}"
    response = client.chat.completions.create(
        model="gpt-3.5-turbo",
         messages=[
            {"role": "system", "content": "Your task is to analyze a user's Reddit post data provided in the format: 'Title: \"[title]\", Content: \"[content]\", Username: \"[username]\", Date of Post: \"[date_of_post]\", URL of Post: \"[url]\"'. The title of the post is \"[title]\". The content is \"[content]\". The username of the user who posted this is \"[username]\". It was posted on \"[date_of_post]\". The link of the post is \"[url]\". Based on this information, create a concise summary about the user, focusing on their interests, sentiments, and any recurring themes in their posts. The summary should be 50-60 words, providing insight into the user's activity and preferences on Reddit."},
            {"role": "user", "content": user_details}
        ]
    )
    reply = response.choices[0].message.content
    return reply.strip()

def create_prompt_to_generate_reply(title, content, username, user_summary):
    prompt = f"Title: \"{title}\", Content: \"{content}\", Username: \"{username}\", User Summary: \"{user_summary}\""
    return prompt

training_prompts = [{
    "prompt": create_prompt_to_generate_reply("Fiancé doesn't understand mental health and it makes him less supportive than I'd like", "(29F and 32M) I struggle with anxiety and depression but have been on medication that really works for me for a lot of our relationship. My fiancé is one of the lucky ones with literally no mental health issues or experience with them with friends/family. He doesn't understand how much it can affect someone and can be insensitive. I wish he understood more. How can I get him to understand something that is a big part of me even though the medication does wonders but he has zero understanding of? It makes me afraid of would happen to our relationship if I wasn't on medication. ", "reddityo77", "Summary: 'reddityo77' expresses struggles with anxiety, relationship issues, and self-doubt in various posts. The user seeks advice on understanding mental health, relationships, social anxiety, and emotional challenges. Despite feeling misunderstood, anxious, and clingy, there is a desire to work on the relationship, highlighting a longing for connection and self-improvement amidst emotional turmoil."), 
    "response": "It sounds really tough dealing with your anxiety while feeling misunderstood by your fiancé. Have you tried sitting down with him and explaining how you feel in a calm and open way? It might help him understand better and support you more effectively. Remember, you deserve understanding and support in your relationship. If you ever need professional guidance on navigating these conversations or managing your mental health, I can help. Feel free to contact me personally for this opportunity or if you're seeking the right professional expert to match your needs."
    }, {"prompt": create_prompt_to_generate_reply("My anxiety has manifested into physical symptoms and it's ruining my life", "Pretty much what the title says. I'm a 26-year-old male who began experiencing severe sleep disturbances about a year and a half ago, leading to the development of sleep anxiety, a new challenge on top of my existing struggles with health anxiety and general anxiety. Initially, I faced insomnia-like symptoms, which then progressed to waking up feeling sleepy but unable to fall back asleep, daytime drowsiness, and difficulty concentrating (brain fog). I find it challenging to work for more than a couple of hours; my brain seems to signal fatigue, making it almost impossible to continue. My productivity suffers, leaving me drained. My daily life has been quite difficult for the past year, with work feeling like an overwhelming challenge. Initially, I thought my symptoms might indicate underlying health issues, but everything seems to point back to anxiety or depression. These mental health challenges might be exacerbated by my past heavy drinking and partying. Despite not feeling depressed, my anxiety remains quite severe. I've tried SSRI's, but they were intolerable, making me feel worse and leaving me feeling zombie-like. I know they aren't a long-term solution, but I'm struggling to find an effective treatment. Has anyone else experienced something similar, and if so, what approaches have you found helpful in addressing it.", "Pdiddlet", "Pdiddlet frequently seeks advice on various health issues, including anxiety, sleep disturbances, and medical conditions like brain tumors and pituitary tumors. They also discuss job-related challenges due to health issues, such as finding flexible work arrangements. Pdiddlet's posts reflect a struggle with mental health, physical health, and financial stability, highlighting a complex and challenging period in their life."), "response": "Really sorry to hear about your struggles with sleep and anxiety, it's tough when nothing seems to help. Have you thought about exploring different support options, like therapy or lifestyle changes aimed at reducing anxiety? Sometimes, a fresh approach can make a big difference. If you're unsure where to start or need someone to talk to, I'm here. Let's find a solution that works for you. Feel free to contact me personally for this anytime."}, {"prompt": create_prompt_to_generate_reply("studying with depression", "i'm a student, and i noticed that when i try to focus on something like studying, I sometimes get sad and cry out of nowhere. I'm not sure if it's anxiety or depression. Maybe both? i hate that this happens to me because I then lose focus and have to take a minute to get back to it and focus again. i feel like this wastes my time. any recommendations on how to deal with this would be appreciated. ", "AcanthisittaFickle91", "AcanthisittaFickle91 seems to share posts on diverse topics reflecting their struggles with mental health while studying and their interest in NFT investments. They seek advice for managing emotions affecting productivity. The user engages with the Reddit community for support and information on different subjects, showcasing a mix of personal challenges and financial ventures."), "response": "I truly understand how tough it feels when sadness hits you out of the blue, especially when you're trying to focus on your studies. It's really challenging, and I want you to know that it's perfectly okay to feel this way. You're not facing this alone. If you ever need someone to talk to or are looking for ways to handle these moments, I'm right here for you. Chatting about it might just make things feel lighter and more manageable. Whenever you're ready, just reach out. Together, we can find a way through this."}, {"prompt": create_prompt_to_generate_reply("I 30/M has a fear of cheating on my wife 27/F and its ruining my mental health ", "I(30M) got married to my wife(27F) 10 months ago. Things have been great between us. 2 years ago, i was in a very messed up situation, my ex called off our engagement and never gave a reason, i contracted TB, also faced a hard time from family with no one to talk to. Single and virgin then, i not thinking straight went to a shady spa and did it with a worker. The biggest mistake of my life which led me to further more misery and plethora of hiv test and hiv fear. With extreme difficulty, i managed to overcome this. A year ago, i met my wife, through arranged setup and few months later we got married. Things are great except very small hicups here and there. My wife knows about all above. I told her everything. Recently i came across news of my old friend from school cheating on his wife with a spa worker. He had a habbit of going to these places regularly.Since then, i have beginning to fear, what if one day i do something disgusting like this and destroy everything.. what if i am in such situation again or perhaps some other and end up committing such sin. I haven't visited any spa or similar place since that last visit 2 years ago and don't even think about going there. I even refrain from getting couple spa with my wife at a good place because I don't want to bring up the old thoughts. I love my wife and the thought of cheating or hurting her scares me but given the overthinker i am, i cant stop thinking and fearing that someday i might also unwillingly go down this road.. I have no active thoughts of cheating on my wife, just a fear. I am not even talking to any other women, nor do i have habbit of visiting shady places. I don't drink or smoke. I talked to my wife about this- her response was that our thoughts don't dictate our actions. So whatever thought i have, my actions would matter. What do i do to calm my mind and how do i explain myself? ", "tusharmittal45", "User 'tusharmittal45' frequently seeks advice on personal struggles like fear of cheating, phone technical issues, and health concerns. They engage in discussions related to relationships, mental health, and product experiences. Active in subreddits focused on mental health, relationship advice, and technical support, they demonstrate a mix of vulnerability, seeking solutions, and sharing personal experiences."), "response": "It sounds like you're going through a lot with your fears affecting your relationship. It's really brave to open up about these things. Remember, we're not defined by our thoughts but by our actions.  You can reach out to me directly. You're not alone in this, and taking this step is already a big move forward."} ]